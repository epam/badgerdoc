name: Lint
on:
  pull_request:
    paths:
      - "**.py"
  workflow_dispatch:
    inputs:
      files:
        description: 'Files to lint [optional]'
        required: false
        default: ''

env:
  PYTHON_VERSION: 3.8
  LINT_CONFIG: pyproject.toml


jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool: [ black, isort ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup python $PYTHON_VERSION
        uses: actions/setup-python@v5
        with:
          python-version: $PYTHON_VERSION
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
      - name: List changed files
        run: |
          echo Changed files: ${{ steps.changed-files.outputs.all_changed_files }}
      - name: Determine files to lint
        id: determine-files
        run: |
          if [ "${{ github.event.inputs.files }}" ]; then
            echo "name=files::${{ github.event.inputs.files }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=files::${{ steps.changed-files.outputs.all_changed_files }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Install python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --only dev
      - name: Run Isort
        if: ${{ matrix.tool }} == isort
        run: |
          poetry run isort --config $LINT_CONFIG --check-only {{ steps.determine-files.outputs.files }}
      - name: Run Black
        if: ${{ matrix.tool }} == black
        run: |
          poetry run black --config $LINT_CONFIG --diff --check ${{ steps.determine-files.outputs.files }}
